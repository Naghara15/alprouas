<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Home - Bebras Store</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
</head>
  <body>
    <div class="top-header">
      <div class="top-nav" style="padding: 0 40px; align-items: center; height: 60px;">
        <div class="left-links" style="display: flex; align-items: center; gap: 20px;">
          <h1 class="marketplace-title" style="color: white; margin: 0; font-size: 1.8rem; font-weight: 700;">Bebras Store</h1>
        </div>
        <div class="search-bar" style="flex-grow: 1; margin: 0 20px;">
          <form id="top-search-form" onsubmit="return false;" style="display: flex;">
            <input type="text" id="top-search-input" placeholder="Cari produk" style="flex-grow: 1; padding: 10px 15px; font-size: 1rem; border-radius: 4px 0 0 4px; border: 1px solid #ddd; outline: none;" />
          
          </form>
           <button type="submit" aria-label="Search" style="background-color: #003b24; border: none; color: white; padding: 0 25px; font-size: 1.2rem; border-radius: 0 4px 4px 0; cursor: pointer; transition: background-color 0.3s ease;">
              üîç
            </button>
        </div>
        <div class="right-links" style="display: flex; align-items: center; gap: 20px;">
          <p id="nama-user" style="font-weight: 700; color: white; text-decoration: none;"></p>
          <p id="saldo-user" style="font-weight: 700; color: white; text-decoration: none;"></p>
          <a href="cart.html" id="cart-link" style="color: white; text-decoration: none; position: relative;">
            <img src="img/cart.png" alt="Cart" style="height: 24px; vertical-align: middle;" />
            <span id="cart-count" style="position: absolute; top: -8px; right: -8px; background: red; color: white; font-size: 12px; border-radius: 50%; padding: 2px 6px;">0</span>
          </a>
          <button id="logout-btn" class="btn logout-btn">Logout</button>
        </div>
      </div>
    </div>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Product Detail - Bebras Store</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Additional styles for product detail page */
    #product-detail {
      max-width: 900px;
      margin: 40px auto;
      display: flex;
      gap: 40px;
      flex-wrap: wrap;
    }
    .product-images {
      flex: 1 1 300px;
    }
    .product-images img.main-image {
      width: 100%;
      border-radius: 12px;
      margin-bottom: 15px;
    }
    .product-thumbnails {
      display: flex;
      gap: 10px;
    }
    .product-thumbnails img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.3s ease;
    }
    .product-thumbnails img.selected {
      border-color: #27ae60;
    }
    .product-info {
      flex: 1 1 400px;
    }
    .product-info h2 {
      font-size: 2rem;
      margin-bottom: 10px;
      color: #2c3e50;
    }
    .product-info .price {
      font-size: 1.8rem;
      font-weight: 700;
      color: #27ae60;
      margin-bottom: 15px;
    }
    .product-info .rating {
      margin-bottom: 15px;
      color: #f1c40f;
      font-weight: 600;
    }
    .product-info .sold {
      color: #7f8c8d;
      margin-bottom: 15px;
    }
    .product-info .detail-section {
      margin-bottom: 20px;
    }
    .product-info .detail-section strong {
      color: #27ae60;
    }
    .product-info .description {
      white-space: pre-wrap;
      margin-bottom: 20px;
      line-height: 1.4;
    }
    .purchase-section {
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 20px;
      max-width: 300px;
      font-size: 1rem;
      color: #34495e;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: fit-content;
    }
    .purchase-section .quantity-control {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    .purchase-section button.qty-btn {
      background: #27ae60;
      color: white;
      border: none;
      padding: 5px 12px;
      font-size: 1.2rem;
      border-radius: 6px;
      cursor: pointer;
      user-select: none;
      transition: background 0.3s ease;
    }
    .purchase-section button.qty-btn:hover {
      background: #219150;
    }
    .purchase-section .stock-info {
      margin-left: auto;
      font-weight: 600;
    }
    .purchase-section .subtotal {
      font-weight: 700;
      font-size: 1.3rem;
      margin-bottom: 15px;
    }
    .purchase-section .btn-add-cart,
    .purchase-section .btn-buy {
      width: 100%;
      padding: 12px 0;
      font-weight: 700;
      border-radius: 8px;
      cursor: pointer;
      border: none;
      transition: background 0.3s ease;
      margin-bottom: 10px;
    }
    .purchase-section .btn-add-cart {
      background: white;
      color: #27ae60;
      border: 2px solid #27ae60;
    }
    .purchase-section .btn-add-cart:hover {
      background: #27ae60;
      color: white;
    }
    .purchase-section .btn-buy {
      background: #27ae60;
      color: white;
    }
    .purchase-section .btn-buy:hover {
      background: #219150;
    }
  </style>
</head>
<body>
  <div id="app">
    <section id="product-detail">
      <div class="product-images">
        <img src="" alt="Product Image" class="main-image" id="main-image" />
        <div class="product-thumbnails" id="thumbnails"></div>
      </div>
      <div class="product-info">
        <h2 id="product-name"></h2>
        <div class="sold" id="product-sold"></div>
        <div class="rating" id="product-rating"></div>
        <div class="price" id="product-price"></div>
        <div class="detail-section">
          <div><strong>Deskripsi: </strong><span id="product-deskripsi"></span></div>
        </div>
        <div class="description" id="product-description"></div>
        <div class="purchase-section">
          <div class="quantity-control">
            <button class="qty-btn" id="qty-decrease">-</button>
            <input type="number" id="qty-input" value="1" min="1" style="width: 50px; text-align: center;" />
            <button class="qty-btn" id="qty-increase">+</button>
            <div class="stock-info">Stok Total: <span id="product-stock"></span></div>
          </div>
          <div class="subtotal">Subtotal: Rp <span id="subtotal-price"></span></div>
          <button class="btn-add-cart">+ Keranjang</button>
        </div>
      </div>
    </section>
  </div>
  
  <script>
    async function getProductById(id) {
      const user_id = getCookie('userid')
      try {
        const response = await fetch(`http://localhost:8080/product?id=${encodeURIComponent(id)}`);
        const data = await response.json();
        return data;
      } catch (error) {
        console.error('Error:', error);
        // Tampilkan error ke user jika perlu
      }
    }

    function formatPrice(price) {
      return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function updateMainImage(src) {
      const mainImage = document.getElementById("main-image");
      mainImage.src = src;
    }

    function renderThumbnails(images) {
      const thumbnailsContainer = document.getElementById("thumbnails");
      thumbnailsContainer.innerHTML = "";
      images.forEach((imgSrc, index) => {
        const img = document.createElement("img");
        img.src = imgSrc;
        img.alt = "Thumbnail " + (index + 1);
        img.className = index === 0 ? "selected" : "";
        img.addEventListener("click", () => {
          updateMainImage(imgSrc);
          document.querySelectorAll(".product-thumbnails img").forEach(el => el.classList.remove("selected"));
          img.classList.add("selected");
        });
        thumbnailsContainer.appendChild(img);
      });
    }

    function renderProductDetails(product) {
      document.getElementById("nama-user").textContent = "Halo " + getCookie('name') + '!';
      document.getElementById("saldo-user").textContent = 'Rp ' + getCookie('saldo').toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      document.getElementById("product-name").textContent = product.name;
      document.getElementById("product-price").textContent = "Rp " + formatPrice(parseInt(product.price));
      document.getElementById("product-sold").textContent = "Terjual " + product.sold + "+";
      document.getElementById("product-rating").textContent = "‚≠ê " + product.rating;
      // document.getElementById("product-condition").textContent = product.condition;
      // document.getElementById("product-min-order").textContent = product.minOrder;
      // document.getElementById("product-etalase").textContent = product.etalase;
      document.getElementById("product-deskripsi").textContent = product.description;
      document.getElementById("product-stock").textContent = product.stock;
      updateMainImage(product.image);
      // renderThumbnails(product.images);
      updateSubtotal(1, product.price);
    }

    async function updateCartCount() {
      const userId = getCookie("userid")

      try {
        const response = await fetch("http://localhost:8080/notificationcart", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            user_id: parseInt(userId)
          })
        });

        if (!response.ok) {
          throw new Error("Gagal mengirim notifikasi jumlah keranjang.");
        }

        const cartCount = await response.json()
        document.getElementById("cart-count").textContent = cartCount;
        
      } catch (error) {
        console.error("Error notifikasi cart:", error);
        document.getElementById("cart-count").textContent = 0;
      }
}

async function addToCart(product, qty) {
  const userId = getCookie("userid")
  try {
    // Panggil API untuk simpan ke server
    const response = await fetch("http://localhost:8080/addcart", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        user_id: parseInt(userId),
        product_id: product.id,
        qty: qty
      })
    });

    if (!response.ok) {
      throw new Error("Gagal menambahkan ke keranjang di server.");
    }

    updateCartCount();
    alert("Produk berhasil ditambahkan ke keranjang!");
  } catch (error) {
    console.error("Error saat menambahkan ke keranjang:", error);
    alert("Terjadi kesalahan saat menambahkan produk ke keranjang.");
  }
}

document.querySelector(".btn-add-cart").addEventListener("click", () => {
  let qty = parseInt(qtyInput.value);
  if (isNaN(qty) || qty < 1) qty = 1;

  if (qty > currentProduct.stock) {
    alert("Jumlah melebihi stok!");
    return;
  }

  console.log(currentProduct.id)
  addToCart(currentProduct, qty);
});

    function updateSubtotal(quantity, price) {
      const subtotalElem = document.getElementById("subtotal-price");
      subtotalElem.textContent = formatPrice(quantity * price);
    }

    // Quantity controls
    const qtyInput = document.getElementById("qty-input");
    const qtyDecrease = document.getElementById("qty-decrease");
    const qtyIncrease = document.getElementById("qty-increase");

    qtyDecrease.addEventListener("click", () => {
      let current = parseInt(qtyInput.value);
      if (current > 1) {
        qtyInput.value = current - 1;
        updateSubtotal(qtyInput.value, currentProduct.price);
      }
    });

    qtyIncrease.addEventListener("click", () => {
      let current = parseInt(qtyInput.value);
      if (current < currentProduct.stock) {
        qtyInput.value = current + 1;
        updateSubtotal(qtyInput.value, currentProduct.price);
      }
    });

    qtyInput.addEventListener("input", () => {
      let val = parseInt(qtyInput.value);
      if (isNaN(val) || val < 1) {
        qtyInput.value = 1;
      } else if (val > currentProduct.stock) {
        qtyInput.value = currentProduct.stock;
      }
      updateSubtotal(qtyInput.value, currentProduct.price);
    });

    // Load product based on URL param
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    let currentProduct = null;

    window.addEventListener("load", async () => {
      const currentUser = getCookie("userid");
      if (!currentUser) {
        window.location.href = "login.html";
      }
      const id = parseInt(getQueryParam("id"));
      if (!id) {
        alert("Product ID not specified.");
        window.location.href = "home.html";
        return;
      }
      currentProduct = await getProductById(id);
      if (!currentProduct) {
        alert("Product not found.");
        window.location.href = "home.html";
        return;
      }
      renderProductDetails(currentProduct);
      updateCartCount();

    });
    
    function getCookie(name) {
      const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
      return match ? match[2] : null;
    }

    document.getElementById("logout-btn").addEventListener("click", () => {
      document.cookie = "userid=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT";
      window.location.href = "login.html";
    });
  </script>
</body>
</html>
