<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Home - Bebras Store</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Slider styles */
    .slider {
      position: relative;
      width: 100%;
      max-width: 1200px;
      height: 180px;
      margin: 0 auto 30px auto;
      overflow: hidden;
      border-radius: 12px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.1);
      background: #1a1a2e;
      color: white;
      font-family: 'Poppins', sans-serif;
    }
    .slides {
      display: flex;
      transition: transform 0.5s ease-in-out;
      height: 100%;
    }
    .slide {
      min-width: 100%;
      box-sizing: border-box;
      padding: 20px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
    }
    .slide-content {
      max-width: 60%;
    }
    .slide-content h2 {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 10px;
    }
    .slide-content p {
      font-size: 1rem;
      margin-bottom: 15px;
      color: #a0a0a0;
    }
    .slide-content .discount {
      font-weight: 600;
      font-size: 1.1rem;
      color: #f39c12;
    }
    .slide img {
      max-height: 140px;
      border-radius: 12px;
      object-fit: contain;
    }
    /* Navigation arrows */
    .slider-nav {
      position: absolute;
      top: 50%;
      width: 100%;
      display: flex;
      justify-content: space-between;
      transform: translateY(-50%);
      pointer-events: none;
    }
    .slider-nav button {
      background: rgba(255,255,255,0.3);
      border: none;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      cursor: pointer;
      pointer-events: all;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: #1a1a2e;
      transition: background 0.3s ease;
    }
    .slider-nav button:hover {
      background: #f39c12;
      color: white;
    }
    /* Dots */
    .slider-dots {
      position: absolute;
      bottom: 15px;
      width: 100%;
      text-align: center;
    }
    .slider-dots button {
      background: rgba(255,255,255,0.3);
      border: none;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin: 0 5px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .slider-dots button.active,
    .slider-dots button:hover {
      background: #f39c12;
    }
  </style>
</head>
<body>
  <div class="top-header">
    <div class="top-nav" style="padding: 0 40px; align-items: center; height: 60px;">
      <div class="left-links" style="display: flex; align-items: center; gap: 20px;">
        <h1 class="marketplace-title" style="color: white; margin: 0; font-size: 1.8rem; font-weight: 700;">Bebras Store</h1>
      </div>
      <div class="search-bar" style="flex-grow: 1; margin: 0 20px;">
        <form id="top-search-form" onsubmit="return false;" style="display: flex;">
          <input type="text" id="top-search-input" placeholder="Cari produk" style="flex-grow: 1; padding: 10px 15px; font-size: 1rem; border-radius: 4px 0 0 4px; border: 1px solid #ddd; outline: none;" />
          
        </form>
         <button type="submit" aria-label="Search" style="background-color: #1cab4ea0; border: none; color: white; padding: 0 25px; font-size: 1.2rem; border-radius: 0 4px 4px 0; cursor: pointer; transition: background-color 0.3s ease;">
              üîç
            </button>
      </div>
      <div class="right-links" style="display: flex; align-items: center; gap: 20px;">
        <span id="user-info" style="font-weight: 400;"></span>
        <p id='name-user' style="font-weight: 700; color: white; text-decoration: none;"></p>
        <p id='saldo-user' style="font-weight: 700; color: white; text-decoration: none;"></p>
        <a href="cart.html" id="cart-link" style="color: white; text-decoration: none; position: relative;">
          <img src="img/cart.png" alt="Cart" style="height: 24px; vertical-align: middle;" />
          <span id="cart-count" style="position: absolute; top: -8px; right: -8px; background: red; color: white; font-size: 12px; border-radius: 50%; padding: 2px 6px;">0</span>
        </a>
        <button id="logout-btn" class="btn logout-btn">Logout</button>
      </div>
    </div>
  </div>
  <div id="app">
    <section id="home-page" class="page active">
      <!-- Slider placed above product menu -->
      <div class="slider" id="slider">
        <div class="slides" id="slides">
          <div class="slide">
            <div class="slide-content">
              <p>Best Deal Online on Gamepad</p>
              <h2>Gamepad</h2>
              <p class="discount">UP TO 80% OFF</p>
            </div>
            <img src="img/gamepad.png" alt="Smart Watch" />
          </div>
          <div class="slide">
            <div class="slide-content">
              <p>Exclusive Offer on Laptops</p>
              <h2>POWERFUL PERFORMANCE.</h2>
              <p class="discount">SAVE UP TO 40%</p>
            </div>
            <img src="img/laptop2.png" alt="Laptop" />
          </div>
          <div class="slide">
            <div class="slide-content">
              <p>Fashion Sale</p>
              <h2>STYLISH CLOTHING.</h2>
              <p class="discount">UP TO 50% OFF</p>
            </div>
            <img src="img/baju.jpg" alt="Fashion" />
          </div>
        </div>
        <div class="slider-nav">
          <button id="prevBtn">&#10094;</button>
          <button id="nextBtn">&#10095;</button>
        </div>
        <div class="slider-dots" id="sliderDots"></div>
      </div>
      <nav class="category-menu">
        <button class="category-btn active" data-category="all">All</button>
        <button class="category-btn" data-category="get-recommendation">Get Recommendation</button>
        <!-- <button class="category-btn" data-category="electronics">Electronics</button>
        <button class="category-btn" data-category="fashion">Fashion</button>
        <button class="category-btn" data-category="home">Home</button>
        <button class="category-btn" data-category="books">Books</button> -->
      </nav>
      <main class="product-list" id="product-list">
        <!-- Products will be dynamically inserted here -->
      </main>
    </section>
  </div>

  <script>
    // Slider functionality
    const slides = document.getElementById('slides');
    const slideCount = slides.children.length;
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const sliderDots = document.getElementById('sliderDots');
    let currentIndex = 0;

    function updateSliderPosition() {
      slides.style.transform = `translateX(-${currentIndex * 100}%)`;
      updateDots();
    }

    function updateDots() {
      const dots = sliderDots.querySelectorAll('button');
      dots.forEach((dot, index) => {
        dot.classList.toggle('active', index === currentIndex);
      });
    }

    function goToSlide(index) {
      if (index < 0) {
        currentIndex = slideCount - 1;
      } else if (index >= slideCount) {
        currentIndex = 0;
      } else {
        currentIndex = index;
      }
      updateSliderPosition();
    }

    prevBtn.addEventListener('click', () => {
      goToSlide(currentIndex - 1);
    });

    nextBtn.addEventListener('click', () => {
      goToSlide(currentIndex + 1);
    });

    // Create dots dynamically
    for (let i = 0; i < slideCount; i++) {
      const dot = document.createElement('button');
      dot.addEventListener('click', () => {
        goToSlide(i);
      });
      sliderDots.appendChild(dot);
    }

    // Initialize slider
    updateSliderPosition();

  const productList = document.getElementById("product-list");
  const categoryButtons = document.querySelectorAll(".category-btn");
  const logoutBtn = document.getElementById("logout-btn");

  async function getRecommendations() {
  const userId = getCookie("userid");
  if (!userId) {
    alert("User ID tidak ditemukan di cookie.");
    return;
  }

  try {
    const response = await fetch("http://localhost:8080/recommend", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ user_id: parseInt(userId) })
    });

    if (!response.ok) throw new Error("Gagal mengambil rekomendasi.");

    const data = await response.json();
    renderRecommendedProducts(data); // ‚Üê pake fungsi baru, bukan renderProducts()
  } catch (err) {
    alert("Gagal memuat rekomendasi: " + err.message);
  }
}

function getCookie(name) {
  const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
  return match ? match[2] : null;
}


  function renderRecommendedProducts(recommendedProducts) {
  productList.innerHTML = "";

  recommendedProducts.forEach(product => {
    const productCard = document.createElement("div");
    productCard.className = "product-card";
    productCard.innerHTML = `
      <a href="product.html?id=${product.id}" class="product-link" onclick=addCounter(${product.id})>
        <img src="${product.image}" alt="${product.name}" />
        <h3>${product.name}</h3>
      </a>
      <p class="price">Rp ${product.price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".")}</p>
      <div class="product-buttons">
        <button class="btn btn-keranjang" data-id="${product.id}">Keranjang</button>
      </div>
    `;
    productList.appendChild(productCard);
  });

  // Attach event listener untuk keranjang
  const cartButtons = document.querySelectorAll(".btn-keranjang");
  cartButtons.forEach(button => {
    button.addEventListener("click", () => {
      const id = parseInt(button.dataset.id);
      const product = recommendedProducts.find(p => p.id === id);
      if (product) {
        addToCart(product);
      }
    });
  });
}

function renderCategory() {
  const categoryMenu = document.querySelector(".category-menu");
  document.getElementById("name-user").textContent = 'Halo ' + getCookie('name') + '!';
  document.getElementById("saldo-user").textContent = 'Rp ' + getCookie('saldo').toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  fetch("http://localhost:8080/tags")
    .then((response) => {
      if (!response.ok) {
        throw new Error("Gagal memuat kategori dari API");
      }
      return response.json();
    })
    .then((categories) => {
      categoryMenu.innerHTML = ""; // Kosongkan menu terlebih dahulu

      const rec = document.createElement("button");
      rec.classList.add("category-btn");
      rec.classList.add("active");
      rec.dataset.category = "recommended"
      rec.textContent = "Recommended"
      categoryMenu.appendChild(rec);
      rec.addEventListener("click", () => {
          document.querySelectorAll(".category-btn").forEach(btn =>
            btn.classList.remove("active")
          );
          rec.classList.add("active");
          getRecommendations()
        });

      const all = document.createElement("button");
      all.classList.add("category-btn");
      all.dataset.category = "all"
      all.textContent = "All"
      categoryMenu.appendChild(all);
      all.addEventListener("click", () => {
          document.querySelectorAll(".category-btn").forEach(btn =>
            btn.classList.remove("active")
          );
          all.classList.add("active");
          renderProductsAll()
        });

      categories.forEach((category, index) => {
        const button = document.createElement("button");
        button.classList.add("category-btn");
        button.dataset.category = category.id;
        button.textContent = category.name;

        // Tambahkan event listener jika dibutuhkan
        button.addEventListener("click", () => {
          document.querySelectorAll(".category-btn").forEach(btn =>
            btn.classList.remove("active")
          );
          button.classList.add("active");
          // Panggil fungsi lain di sini untuk memuat produk, misalnya:
          loadProductsByCategory(category.id);
        });

        categoryMenu.appendChild(button);
      });
    })
    .catch((error) => {
      console.error("Error saat memuat kategori:", error);
      categoryMenu.innerHTML = "<p>Gagal memuat kategori.</p>";
    });
}

async function loadProductsByCategory(categoryId) {
  try {
    const response = await fetch("http://localhost:8080/products", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify([{tag_id: parseInt(categoryId) }])
    });

    if (!response.ok) throw new Error("Gagal mengambil produk.");

    const data = await response.json();
    productList.innerHTML = "";
    data.forEach(product => {
    const productCard = document.createElement("div");
    productCard.className = "product-card";
    productCard.innerHTML = `
      <a href="product.html?id=${product.id}" class="product-link" onclick=addCounter(${product.id})>
        <img src="${product.image}" alt="${product.name}" />
        <h3>${product.name}</h3>
      </a>
      <p class="price">Rp ${product.price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".")}</p>
      <div class="product-buttons">
        <button class="btn btn-keranjang" data-id="${product.id}">Keranjang</button>
      </div>
    `;
    productList.appendChild(productCard);

  });
  } catch (err) {
    alert("Gagal memuat rekomendasi: " + err.message);
  }
}

  async function renderProductsAll() {
  productList.innerHTML = "";
  const response = await fetch("http://localhost:8080/products");
  const products = await response.json();

  products.forEach(product => {
    const productCard = document.createElement("div");
    productCard.className = "product-card";
    productCard.innerHTML = `
      <a href="product.html?id=${product.id}" class="product-link" onclick=addCounter(${product.id})>
        <img src="${product.image}" alt="${product.name}" />
        <h3>${product.name}</h3>
      </a>
      <p class="price">Rp ${product.price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".")}</p>
      <div class="product-buttons">
        <button class="btn btn-keranjang" data-id="${product.id}">Keranjang</button>
      </div>
    `;
    productList.appendChild(productCard);
  });

  // Tambahkan event listener ke tombol keranjang setelah render
  const cartButtons = document.querySelectorAll(".btn-keranjang");
  cartButtons.forEach(button => {
    button.addEventListener("click", () => {
      const id = parseInt(button.dataset.id);
      const product = products.find(p => p.id === id);
      if (product) {
        addToCart(product);
      }
    });
  });
}


function addToCheckout(product) {
  localStorage.setItem('checkoutItems', JSON.stringify([product]));
  window.location.href = "checkout.html";
}

async function addToCart(product) {
  const userid = getCookie("userid")

  // Kirim data ke backend
  try {
    const response = await fetch("http://localhost:8080/addcart", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        user_id: parseInt(userid),
        product_id: product.id,
        qty: 1
      }),
    });

    if (!response.ok) {
      throw new Error("Gagal menambahkan ke keranjang di server.");
    }

    updateCartBadge()
    alert("Produk ditambahkan ke keranjang!");
  } catch (error) {
    console.error("Error saat mengirim ke backend:", error);
  }
}

async function updateCartBadge() {
  const badge = document.getElementById("cart-count");
  const userid = getCookie("userid")

  // Kirim notifikasi jumlah cart ke server
  try {
    const response = await fetch("http://localhost:8080/notificationcart", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        user_id: parseInt(userid)
      })
    });

    if (!response.ok) {
      throw new Error("Gagal mengirim notifikasi jumlah keranjang.");
    }

    const cartCount = await response.json()
    if (badge) {
      badge.textContent = cartCount;
    }
  } catch (error) {
    console.error("Error notifikasi cart:", error);
  }
}

  // Filter kategori
  // categoryButtons.forEach(btn => {
  //   btn.addEventListener("click", () => {
  //     categoryButtons.forEach(b => b.classList.remove("active"));
  //     btn.classList.add("active");
  //     renderProductsCategory(btn.dataset.category);
  //   });
  // });

  logoutBtn.addEventListener("click", () => {
    document.cookie = "userid=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT";
    window.location.href = "login.html";
  });

  window.addEventListener("load", () => {
    const currentUser = getCookie("userid");
    if (!currentUser) {
      window.location.href = "login.html";
    } else {
      getRecommendations();
      renderCategory();
      updateCartBadge(); // supaya saat buka halaman, badge cart langsung update
    }
  });

  async function addCounter(productID) {
    const user_id = getCookie('userid')
    try {
      const response = await fetch('http://localhost:8080/addclick', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          user_id: parseInt(user_id),
          product_id: productID
        })
      });
    } catch (error) {
      console.error('Error:', error);
      // Tampilkan error ke user jika perlu
    }
  }
  </script>
</body>
</html>
